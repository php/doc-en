<?xml version="1.0" encoding="utf-8"?>
<!-- $Revision$ -->

<refentry xml:id="mongodb-driver-manager.construct" xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">
 <refnamediv>
  <refname>MongoDB\Driver\Manager::__construct</refname>
  <refpurpose>Create new MongoDB Manager</refpurpose>
 </refnamediv>

 <refsect1 role="description">
  &reftitle.description;
  <methodsynopsis>
   <modifier>final</modifier> <modifier>public</modifier> <methodname>MongoDB\Driver\Manager::__construct</methodname>
   <methodparam choice="opt"><type class="union"><type>string</type><type>null</type></type><parameter>uri</parameter><initializer>&null;</initializer></methodparam>
   <methodparam choice="opt"><type class="union"><type>array</type><type>null</type></type><parameter>uriOptions</parameter><initializer>&null;</initializer></methodparam>
   <methodparam choice="opt"><type class="union"><type>array</type><type>null</type></type><parameter>driverOptions</parameter><initializer>&null;</initializer></methodparam>
  </methodsynopsis>
  <para>
   Constructs a new <classname>MongoDB\Driver\Manager</classname> object with the specified options.
  </para>
  <note>
   <simpara>
    Per the <link xlink:href="&url.mongodb.sdam;#single-threaded-client-construction">Server Discovery and Monitoring Specification</link>,
    this constructor performs no I/O. Connections will be initialized on demand,
    when the first operation is executed.
   </simpara>
  </note>
  <note>
   <simpara>
    When specifying any SSL or TLS URI options via the connection string or
    <parameter>uriOptions</parameter> parameter, the extension will implicitly
    enable TLS for its connections. To avoid this, either explicitly disable the
    <literal>tls</literal> option or don't specify any TLS options.
   </simpara>
  </note>
  &mongodb.note.forking;
 </refsect1>

 <refsect1 role="parameters">
  &reftitle.parameters;
  <variablelist>
   <varlistentry xml:id="mongodb-driver-manager.construct-uri">
    <term><parameter>uri</parameter></term>
    <listitem>
     <para>
      A <link xlink:href="&url.mongodb.docs;reference/connection-string/">mongodb://</link> connection URI:
      <programlisting role="txt">
<![CDATA[
mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[defaultAuthDb][?options]]
]]>
      </programlisting>
     </para>
     <para>
      Defaults to <literal>"mongodb://127.0.0.1:27017"</literal> if unspecified.
     </para>
     <para>
      For details on supported URI options, see
      <link xlink:href="&url.mongodb.docs;reference/connection-string/#connections-connection-options">Connection String Options</link>
      in the MongoDB manual.
      <link xlink:href="&url.mongodb.docs;reference/connection-string/#connection-pool-options">Connection pool options</link>
      are not supported, as the extension does not implement connection pools.
     </para>
     <para>
      The <parameter>uri</parameter> is a URL, hence any special characters in
      its components need to be URL encoded according to
      <link xlink:href="&url.rfc;3986">RFC 3986</link>. This is particularly
      relevant to the username and password, which can often include special
      characters such as <literal>@</literal>, <literal>:</literal>, or
      <literal>%</literal>. When connecting via a Unix domain socket, the socket
      path may contain special characters such as slashes and must be encoded.
      The <function>rawurlencode</function> function may be used to encode
      constituent parts of the URI.
     </para>
     <para>
      The <literal>defaultAuthDb</literal> component may be used to specify the
      database name associated with the user's credentials; however the
      <literal>authSource</literal> URI option will take priority if specified.
      If neither <literal>defaultAuthDb</literal> nor
      <literal>authSource</literal> are specified, the <literal>admin</literal>
      database will be used by default. The <literal>defaultAuthDb</literal>
      component has no effect in the absence of user credentials.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="mongodb-driver-manager.construct-urioptions">
    <term><parameter>uriOptions</parameter></term>
    <listitem>
     <para>
      Additional
      <link xlink:href="&url.mongodb.docs;reference/connection-string/#connections-connection-options">connection string options</link>,
      which will overwrite any options with the same name in the
      <parameter>uri</parameter> parameter.
     </para>
     <para>
      <table>
       <title>uriOptions</title>
       <tgroup cols="3">
        <thead>
         <row>
          <entry>Option</entry>
          <entry>Type</entry>
          <entry>Description</entry>
         </row>
        </thead>
        <tbody>
         <row>
          <entry>appname</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            MongoDB 3.4+ has the ability to annotate connections with metadata
            provided by the connecting client. This metadata is included in the
            server's logs upon establishing a connection and also recorded in
            slow query logs when database profiling is enabled.
           </para>
           <para>
            This option may be used to specify an application name, which will
            be included in the metadata. The value cannot exceed 128 characters
            in length.
           </para>
          </entry>
         </row>
         <row>
          <entry>authMechanism</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            The authentication mechanism that MongoDB will use to authenticate
            the connection. For additional details and a list of supported
            values, see
            <link xlink:href="&url.mongodb.docs;reference/connection-string/#urioption.authMechanism">Authentication Options</link>
            in the MongoDB manual.
           </para>
          </entry>
         </row>
         <row>
          <entry>authMechanismProperties</entry>
          <entry><type>array</type></entry>
          <entry>
           <para>
            Properties for the selected authentication mechanism. For additional
            details and a list of supported properties, see the
            <link xlink:href="&url.mongodb.specs;/blob/master/source/auth/auth.rst#auth-related-options">Driver Authentication Specification</link>.
           </para>
           <note>
            <simpara>
             When not specified in the URI string, this option is expressed as
             an array of key/value pairs. The keys and values in this array
             should be strings.
            </simpara>
           </note>
          </entry>
         </row>
         <row>
          <entry>authSource</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            The database name associated with the user's credentials. Defaults
            to the database component of the connection URI, or the
            <literal>admin</literal> database if both are unspecified.
           </para>
           <para>
            For authentication mechanisms that delegate credential storage to
            other services (e.g. GSSAPI), this should be
            <literal>"$external"</literal>.
           </para>
          </entry>
         </row>
         <row>
          <entry>canonicalizeHostname</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            If &true;, the driver will resolve the real hostname for the server
            IP address before authenticating via SASL. Some underlying GSSAPI
            layers already do this, but the functionality may be disabled in
            their config (e.g. <literal>krb.conf</literal>). Defaults to
            &false;.
           </para>
           <para>
            This option is a deprecated alias for the
            <literal>"CANONICALIZE_HOST_NAME"</literal> property of the
            <literal>"authMechanismProperties"</literal> URI option.
           </para>
          </entry>
         </row>
         <row>
          <entry>compressors</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            A prioritized, comma-delimited list of compressors that the client
            wants to use. Messages are only compressed if the client and server
            share any compressors in common, and the compressor used in each
            direction will depend on the individual configuration of the server
            or driver. See the
            <link xlink:href="&url.mongodb.specs;/blob/master/source/compression/OP_COMPRESSED.rst#compressors">Driver Compression Specification</link>
            for more information.
           </para>
          </entry>
         </row>
         <row xml:id="mongodb-driver-manager.construct-urioptions.connecttimeoutms">
          <entry>connectTimeoutMS</entry>
          <entry><type>int</type></entry>
          <entry>
           <para>
            The time in milliseconds to attempt a connection before timing out.
            Defaults to 10,000 milliseconds.
           </para>
          </entry>
         </row>
         <row>
          <entry>directConnection</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            This option can be used to control replica set discovery behavior
            when only a single host is provided in the connection string. By
            default, providing a single member in the connection string will
            establish a direct connection or discover additional members
            depending on whether the <literal>"replicaSet"</literal> URI option
            is omitted or present, respectively. Specify &false; to force
            discovery to occur (if <literal>"replicaSet"</literal> is omitted)
            or specify &true; to force a direct connection (if
            <literal>"replicaSet"</literal> is present).
           </para>
          </entry>
         </row>
         <row>
          <entry>gssapiServiceName</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            Set the Kerberos service name when connecting to Kerberized MongoDB
            instances. This value must match the service name set on MongoDB
            instances (i.e.
            <link xlink:href="&url.mongodb.docs;reference/parameters/#param.saslServiceName">saslServiceName</link>
            server parameter). Defaults to <literal>"mongodb"</literal>.
           </para>
           <para>
            This option is a deprecated alias for the
            <literal>"SERVICE_NAME"</literal> property of the
            <literal>"authMechanismProperties"</literal> URI option.
           </para>
          </entry>
         </row>
         <row>
          <entry>heartbeatFrequencyMS</entry>
          <entry><type>int</type></entry>
          <entry>
           <para>
            Specifies the interval in milliseconds between the driver's checks
            of the MongoDB topology, counted from the end of the previous check
            until the beginning of the next one. Defaults to 60,000
            milliseconds.
           </para>
           <para>
            Per the
            <link xlink:href="&url.mongodb.sdam;#heartbeatfrequencyms">Server Discovery and Monitoring Specification</link>,
            this value cannot be less than 500 milliseconds.
           </para>
          </entry>
         </row>
         <row>
          <entry>journal</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            Corresponds to the default write concern's
            <parameter>journal</parameter> parameter. If &true;, writes will
            require acknowledgement from MongoDB that the operation has been
            written to the journal. For details, see
            <classname>MongoDB\Driver\WriteConcern</classname>.
           </para>
          </entry>
         </row>
         <row>
          <entry>loadBalanced</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            Specifies whether the driver is connecting to a MongoDB cluster
            through a load balancer. If &true;, the driver may only connect to a
            single host (specified by either the connection string or SRV
            lookup), the <literal>"directConnection"</literal> URI option
            cannot be &true;, and the <literal>"replicaSet"</literal> URI option
            must be omitted. Defaults to &false;.
           </para>
          </entry>
         </row>
         <row>
          <entry>localThresholdMS</entry>
          <entry><type>int</type></entry>
          <entry>
           <para>
            The size in milliseconds of the latency window for selecting among
            multiple suitable MongoDB instances while resolving a read
            preference. Defaults to 15 milliseconds.
           </para>
          </entry>
         </row>
         <row>
          <entry>maxStalenessSeconds</entry>
          <entry><type>int</type></entry>
          <entry>
           <para>
            Corresponds to the read preference's
            <literal>"maxStalenessSeconds"</literal>. Specifies, in seconds, how
            stale a secondary can be before the client stops using it for read
            operations. By default, there is no maximum staleness and clients
            will not consider a secondaryâ€™s lag when choosing where to direct a
            read operation. For details, see
            <classname>MongoDB\Driver\ReadPreference</classname>.
           </para>
           <para>
            If specified, the max staleness must be a signed 32-bit integer
            greater than or equal to
            <constant>MongoDB\Driver\ReadPreference::SMALLEST_MAX_STALENESS_SECONDS</constant>
            (i.e. 90 seconds).
           </para>
          </entry>
         </row>
         <row>
          <entry>password</entry>
          <entry><type>string</type></entry>
          <entry>
           The password for the user being authenticated. This option is useful
           if the password contains special characters, which would otherwise
           need to be URL encoded for the connection URI.
          </entry>
         </row>
         <row>
          <entry>readConcernLevel</entry>
          <entry><type>string</type></entry>
          <entry>
           Corresponds to the read concern's <parameter>level</parameter>
           parameter. Specifies the level of read isolation. For details, see
           <classname>MongoDB\Driver\ReadConcern</classname>.
          </entry>
         </row>
         <row>
          <entry>readPreference</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            Corresponds to the read preference's <parameter>mode</parameter>
            parameter. Defaults to <literal>"primary"</literal>. For details,
            see <classname>MongoDB\Driver\ReadPreference</classname>.
           </para>
          </entry>
         </row>
         <row>
          <entry>readPreferenceTags</entry>
          <entry><type>array</type></entry>
          <entry>
           <para>
            Corresponds to the read preference's <parameter>tagSets</parameter>
            parameter. Tag sets allow you to target read operations to specific
            members of a replica set. For details, see
            <classname>MongoDB\Driver\ReadPreference</classname>.
           </para>
           <note>
            <simpara>
             When not specified in the URI string, this option is expressed as
             an array consistent with the format expected by
             <function>MongoDB\Driver\ReadPreference::__construct</function>.
            </simpara>
           </note>
          </entry>
         </row>
         <row>
          <entry>replicaSet</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            Specifies the name of the replica set.
           </para>
          </entry>
         </row>
         <row>
          <entry>retryReads</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            Specifies whether or not the driver should automatically retry
            certain read operations that fail due to transient network errors
            or replica set elections. This functionality requires MongoDB 3.6+.
            Defaults to &true;.
           </para>
           <para>
            See the
            <link xlink:href="&url.mongodb.specs;/blob/master/source/retryable-reads/retryable-reads.rst">Retryable Reads Specification</link>
            for more information.
           </para>
          </entry>
         </row>
         <row>
          <entry>retryWrites</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            Specifies whether or not the driver should automatically retry
            certain write operations that fail due to transient network errors
            or replica set elections. This functionality requires MongoDB 3.6+.
            Defaults to &true;.
           </para>
           <para>
            See
            <link xlink:href="&url.mongodb.docs;core/retryable-writes/">Retryable Writes</link>
            in the MongoDB manual for more information.
           </para>
          </entry>
         </row>
         <row>
          <entry>safe</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            If &true;, specifies <literal>1</literal> for the default write
            concern's <parameter>w</parameter> parameter. If &false;,
            <literal>0</literal> is specified. For details, see
            <classname>MongoDB\Driver\WriteConcern</classname>.
           </para>
           <para>
            This option is deprecated and should not be used.
           </para>
          </entry>
         </row>
         <row xml:id="mongodb-driver-manager.construct-urioptions.serverselectiontimeoutms">
          <entry>serverSelectionTimeoutMS</entry>
          <entry><type>int</type></entry>
          <entry>
           <para>
            Specifies how long in milliseconds to block for server selection
            before throwing an exception. Defaults to 30,000 milliseconds.
           </para>
          </entry>
         </row>
         <row>
          <entry>serverSelectionTryOnce</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            When &true;, instructs the driver to scan the MongoDB deployment
            exactly once after server selection fails and then either select a
            server or raise an error. When &false;, the driver blocks and
            searches for a server up to the
            <literal>"serverSelectionTimeoutMS"</literal> value. Defaults to
            &true;.
           </para>
          </entry>
         </row>
         <row>
          <entry>socketCheckIntervalMS</entry>
          <entry><type>int</type></entry>
          <entry>
           <para>
            If a socket has not been used recently, the driver must check it via
            a <literal>hello</literal> command before using it for any
            operation. Defaults to 5,000 milliseconds.
           </para>
          </entry>
         </row>
         <row>
          <entry>socketTimeoutMS</entry>
          <entry><type>int</type></entry>
          <entry>
           <para>
            The time in milliseconds to attempt a send or receive on a socket
            before timing out. Defaults to 300,000 milliseconds (i.e. five
            minutes).
           </para>
          </entry>
         </row>
         <row>
          <entry>srvMaxHosts</entry>
          <entry><type>int</type></entry>
          <entry>
           <para>
            The maximum number of SRV results to randomly select when initially
            populating the seedlist or, during SRV polling, adding new hosts to
            the topology. Defaults to <literal>0</literal> (i.e. no maximum).
           </para>
          </entry>
         </row>
         <row>
          <entry>srvServiceName</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            The service name to use for SRV lookup in initial DNS seedlist
            discovery and SRV polling. Defaults to <literal>"mongodb"</literal>.
           </para>
          </entry>
         </row>
         <row>
          <entry>ssl</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            Initiates the connection with TLS/SSL if &true;. Defaults to
            &false;.
           </para>
           <para>
            This option is a deprecated alias for the <literal>"tls"</literal>
            URI option.
           </para>
          </entry>
         </row>
         <row>
          <entry>tls</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            Initiates the connection with TLS/SSL if &true;. Defaults to
            &false;.
           </para>
          </entry>
         </row>
         <row>
          <entry>tlsAllowInvalidCertificates</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            Specifies whether or not the driver should error when the server's
            TLS certificate is invalid. Defaults to &false;.
           </para>
           <warning>
            <simpara>
             Disabling certificate validation creates a vulnerability.
            </simpara>
           </warning>
          </entry>
         </row>
         <row>
          <entry>tlsAllowInvalidHostnames</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            Specifies whether or not the driver should error when there is a
            mismatch between the server's hostname and the hostname specified by
            the TLS certificate. Defaults to &false;.
           </para>
           <warning>
            <simpara>
             Disabling certificate validation creates a vulnerability. Allowing
             invalid hostnames may expose the driver to a
             <link xlink:href="&url.mongodb.wiki.mitm;">man-in-the-middle attack</link>.
            </simpara>
           </warning>
          </entry>
         </row>
         <row>
          <entry>tlsCAFile</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            Path to file with either a single or bundle of certificate
            authorities to be considered trusted when making a TLS connection.
            The system certificate store will be used by default.
           </para>
          </entry>
         </row>
         <row>
          <entry>tlsCertificateKeyFile</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            Path to the client certificate file or the client private key file;
            in the case that they both are needed, the files should be
            concatenated.
           </para>
          </entry>
         </row>
         <row>
          <entry>tlsCertificateKeyFilePassword</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            Password to decrypt the client private key (i.e.
            <literal>"tlsCertificateKeyFile"</literal> URI option) to be used
            for TLS connections.
           </para>
          </entry>
         </row>
         <row>
          <entry>tlsDisableCertificateRevocationCheck</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            If &true;, the driver will not attempt to check certificate
            revocation status (e.g. OCSP, CRL). Defaults to &false;.
           </para>
          </entry>
         </row>
         <row>
          <entry>tlsDisableOCSPEndpointCheck</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            If &true;, the driver will not attempt to contact an OCSP responder
            endpoint if needed (i.e. an OCSP response is not stapled). Defaults
            to &false;.
           </para>
          </entry>
         </row>
         <row>
          <entry>tlsInsecure</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            Relax TLS constraints as much as possible. Specifying &true; for
            this option has the same effect as specifying &true; for both the
            <literal>"tlsAllowInvalidCertificates"</literal> and
            <literal>"tlsAllowInvalidHostnames"</literal> URI options. Defaults
            to &false;.
           </para>
           <warning>
            <simpara>
             Disabling certificate validation creates a vulnerability. Allowing
             invalid hostnames may expose the driver to a
             <link xlink:href="&url.mongodb.wiki.mitm;">man-in-the-middle attack</link>.
            </simpara>
           </warning>
          </entry>
         </row>
         <row>
          <entry>username</entry>
          <entry><type>string</type></entry>
          <entry>
           The username for the user being authenticated. This option is useful
           if the username contains special characters, which would otherwise
           need to be URL encoded for the connection URI.
          </entry>
         </row>
         <row>
          <entry>w</entry>
          <entry><type class="union"><type>int</type><type>string</type></type></entry>
          <entry>
           <para>
            Corresponds to the default write concern's <parameter>w</parameter>
            parameter. For details, see
            <classname>MongoDB\Driver\WriteConcern</classname>.
           </para>
          </entry>
         </row>
         <row>
          <entry>wTimeoutMS</entry>
          <entry><type class="union"><type>int</type><type>string</type></type></entry>
          <entry>
           <para>
            Corresponds to the default write concern's
            <parameter>wtimeout</parameter> parameter. Specifies a time limit,
            in milliseconds, for the write concern. For details, see
            <classname>MongoDB\Driver\WriteConcern</classname>.
           </para>
           <para>
            If specified, <literal>wTimeoutMS</literal> must be a signed 32-bit
            integer greater than or equal to zero.
           </para>
          </entry>
         </row>
         <row>
          <entry>zlibCompressionLevel</entry>
          <entry><type>int</type></entry>
          <entry>
           <para>
            Specifies the compression level to use for the zlib compressor. This
            option has no effect if <literal>zlib</literal> is not included in
            the <literal>"compressors"</literal> URI option. See the
            <link xlink:href="&url.mongodb.specs;/blob/master/source/compression/OP_COMPRESSED.rst#zlibcompressionlevel">Driver Compression Specification</link>
            for more information.
           </para>
          </entry>
         </row>
        </tbody>
       </tgroup>
      </table>
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="mongodb-driver-manager.construct-driveroptions">
    <term><parameter>driverOptions</parameter></term>
    <listitem>
     <para>
      <table>
       <title>driverOptions</title>
       <tgroup cols="3">
        <thead>
         <row>
          <entry>Option</entry>
          <entry>Type</entry>
          <entry>Description</entry>
         </row>
        </thead>
        <tbody>
         <row>
          <entry>allow_invalid_hostname</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            Disables hostname validation if &true;. Defaults to &false;.
           </para>
           <para>
            Allowing invalid hostnames may expose the driver to a
            <link xlink:href="&url.mongodb.wiki.mitm;">man-in-the-middle attack</link>.
           </para>
           <para>
            This option is a deprecated alias for the
            <literal>"tlsAllowInvalidHostnames"</literal> URI option.
           </para>
          </entry>
         </row>
         <row>
          <entry>autoEncryption</entry>
          <entry><type>array</type></entry>
          <entry>
           <para>
            Provides options to enable automatic client-side field level
            encryption.
           </para>
           <note>
            <para>
             Automatic encryption is an enterprise-only feature that only
             applies to operations on a collection. Automatic encryption is not
             supported for operations on a database or view, and operations that
             are not bypassed will result in error (see
             <link xlink:href="https://github.com/mongodb/specifications/blob/master/source/client-side-encryption/client-side-encryption.rst#libmongocrypt-auto-encryption-allow-list">libmongocrypt: Auto Encryption Allow-List</link>). To bypass automatic encryption
             for all operations, set <literal>bypassAutoEncryption</literal> to
             &true;.
            </para>
            <para>
             Automatic encryption requires the authenticated user to have the
             <link xlink:href="&url.mongodb.docs;reference/command/listCollections/#required-access">listCollections</link>
             privilege action.
            </para>
            <para>
             Explicit encryption/decryption and automatic decryption is a
             community feature. The driver can still automatically decrypt when
             <literal>bypassAutoEncryption</literal> is &true;.
            </para>
           </note>
           <para>
            The following options are supported:

            <table>
             <title>Options for automatic encryption</title>
             <tgroup cols="3">
              <thead>
               <row>
                <entry>Option</entry>
                <entry>Type</entry>
                <entry>Description</entry>
               </row>
              </thead>
              <tbody>
               &mongodb.option.encryption.keyVaultClient;
               &mongodb.option.encryption.keyVaultNamespace;
               &mongodb.option.encryption.kmsProviders;
               &mongodb.option.encryption.tlsOptions;
               <row>
                <entry>schemaMap</entry>
                <entry><type class="union"><type>array</type><type>object</type></type></entry>
                <entry>
                 <para>
                  Map of collection namespaces to a local JSON schema. This is
                  used to configure automatic encryption. See
                  <link xlink:href="&url.mongodb.docs;reference/security-client-side-automatic-json-schema/">Automatic Encryption Rules</link>
                  in the MongoDB manual for more information. It is an error to
                  specify a collection in both <literal>schemaMap</literal> and
                  <literal>encryptedFieldsMap</literal>.
                 </para>
                 <note>
                  <simpara>
                   Supplying a <literal>schemaMap</literal> provides more
                   security than relying on JSON schemas obtained from the
                   server. It protects against a malicious server advertising a
                   false JSON schema, which could trick the client into sending
                   unencrypted data that should be encrypted.
                  </simpara>
                 </note>
                 <note>
                  <simpara>
                   Schemas supplied in the <literal>schemaMap</literal> only
                   apply to configuring automatic encryption for client side
                   encryption. Other validation rules in the JSON schema will
                   not be enforced by the driver and will result in an error.
                  </simpara>
                 </note>
                </entry>
               </row>
               <row>
                <entry>bypassAutoEncryption</entry>
                <entry><type>bool</type></entry>
                <entry>
                 If &true;, <literal>mongocryptd</literal> will not be spawned
                 automatically. This is used to disable automatic encryption.
                 Defaults to &false;.
                </entry>
               </row>
               <row>
                <entry>bypassQueryAnalysis</entry>
                <entry><type>bool</type></entry>
                <entry>
                 <para>
                  If &true;, automatic analysis of outgoing commands will be
                  disabled and <literal>mongocryptd</literal> will not be
                  spawned automatically. This enables the use case of explicit
                  encryption for querying indexed fields without requiring the
                  enterprise licensed <literal>crypt_shared</literal> library or
                  <literal>mongocryptd</literal> process. Defaults to &false;.
                 </para>
                </entry>
               </row>
               <row>
                <entry>encryptedFieldsMap</entry>
                <entry><type class="union"><type>array</type><type>object</type></type></entry>
                <entry>
                 <para>
                  Map of collection namespaces to an
                  <literal>encryptedFields</literal> document. This is used to
                  configure queryable encryption. See
                  <link xlink:href="&url.mongodb.docs;core/queryable-encryption/fundamentals/encrypt-and-query/">Field Encryption and Queryability</link>
                  in the MongoDB manual for more information. It is an error to
                  specify a collection in both
                  <literal>encryptedFieldsMap</literal> and
                  <literal>schemaMap</literal>.
                 </para>
                 <note>
                  <simpara>
                   Supplying an <literal>encryptedFieldsMap</literal> provides
                   more security than relying on an
                   <literal>encryptedFields</literal> obtained from the server.
                   It protects against a malicious server advertising a false
                   <literal>encryptedFields</literal>.
                  </simpara>
                 </note>
                </entry>
               </row>
               <row>
                <entry>extraOptions</entry>
                <entry><type>array</type></entry>
                <entry>
                 <para>
                  The <literal>extraOptions</literal> relate to the
                  <literal>mongocryptd</literal> process. The following options
                  are supported:
                 </para>
                 <simplelist>
                  <member><literal>mongocryptdURI</literal> (<type>string</type>): URI to connect to an existing <literal>mongocryptd</literal> process. Defaults to <literal>"mongodb://localhost:27020"</literal>.</member>
                  <member><literal>mongocryptdBypassSpawn</literal> (<type>bool</type>): If &true;, prevent the driver from spawning <literal>mongocryptd</literal>. Defaults to &false;.</member>
                  <member><literal>mongocryptdSpawnPath</literal> (<type>string</type>): Absolute path to search for <literal>mongocryptd</literal> binary. Defaults to empty string and consults system paths.</member>
                  <member><literal>mongocryptdSpawnArgs</literal> (<type>array</type>): Array of string arguments to pass to <literal>mongocryptd</literal> when spawning. Defaults to <literal>["--idleShutdownTimeoutSecs=60"]</literal>.</member>
                  <member><literal>cryptSharedLibPath</literal> (<type>string</type>): Absolute path to <literal>crypt_shared</literal> shared library. Defaults to empty string and consults system paths.</member>
                  <member><literal>cryptSharedLibRequired</literal> (<type>bool</type>): If &true;, require the driver to load <literal>crypt_shared</literal>. Defaults to &false;.</member>
                 </simplelist>
                 <para>
                  See the <link xlink:href="&url.mongodb.specs;/blob/master/source/client-side-encryption/client-side-encryption.rst#extraoptions">Client-Side Encryption Specification</link> for more information.
                 </para>
                </entry>
               </row>
              </tbody>
             </tgroup>
            </table>
           </para>

           <note>
            <simpara>
             Automatic encryption is an enterprise only feature that only
             applies to operations on a collection. Automatic encryption is not
             supported for operations on a database or view, and operations that
             are not bypassed will result in error. To bypass automatic
             encryption for all operations, set <literal>bypassAutoEncryption=true</literal>
             in <literal>autoEncryption</literal>. For more information on
             allowed operations, see the
             <link xlink:href="&url.mongodb.specs;/blob/master/source/client-side-encryption/client-side-encryption.rst#libmongocrypt-auto-encryption-whitelist">Client-Side Encryption Specification</link>.
            </simpara>
           </note>
          </entry>
         </row>
         <row>
          <entry>ca_dir</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            Path to a correctly hashed certificate directory. The system
            certificate store will be used by default.
           </para>
          </entry>
         </row>
         <row>
          <entry>ca_file</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            Path to file with either a single or bundle of certificate
            authorities to be considered trusted when making a TLS connection.
            The system certificate store will be used by default.
           </para>
           <para>
            This option is a deprecated alias for the
            <literal>"tlsCAFile"</literal> URI option.
           </para>
          </entry>
         </row>
         <row>
          <entry>context</entry>
          <entry><type>resource</type></entry>
          <entry>
           <para>
            <link linkend="context.ssl">SSL context options</link> to be used as
            fallbacks if a driver option or its equivalent URI option, if any,
            is not specified. Note that the extension does not consult the
            default stream context (i.e.
            <function>stream_context_get_default</function>). The following
            context options are supported:
           </para>

           <table>
            <title>SSL context option fallbacks</title>
            <tgroup cols="2">
             <thead>
              <row>
               <entry>Driver option</entry>
               <entry>Context option (fallback)</entry>
              </row>
             </thead>
             <tbody>
              <row>
               <entry>ca_dir</entry>
               <entry>capath</entry>
              </row>
              <row>
               <entry>ca_file</entry>
               <entry>cafile</entry>
              </row>
              <row>
               <entry>pem_file</entry>
               <entry>local_cert</entry>
              </row>
              <row>
               <entry>pem_pwd</entry>
               <entry>passphrase</entry>
              </row>
              <row>
               <entry>weak_cert_validation</entry>
               <entry>allow_self_signed</entry>
              </row>
             </tbody>
            </tgroup>
           </table>
           <para>
            This option is supported for backwards compatibility, but should be
            considered deprecated.
           </para>
          </entry>
         </row>
         <row>
          <entry>crl_file</entry>
          <entry><type>string</type></entry>
          <entry>Path to a certificate revocation list file.</entry>
         </row>
         <row>
          <entry>disableClientPersistence</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            If &true;, this Manager will use a new libmongoc client, which will
            not be persisted or shared with other Manager objects. When this
            Manager object is freed, its client will be destroyed and any
            connections will be closed. Defaults to &false;.
           </para>
           <note>
            <simpara>
             Disabling client persistence is not generally recommended.
            </simpara>
           </note>
          </entry>
         </row>
         <row>
          <entry>driver</entry>
          <entry><type>array</type></entry>
          <entry>
           <para>
            Allows a higher level library to append its own metadata to the
            server handshake. By default, the extension submits its own name,
            version, and platform (i.e. PHP version) in the handshake. Strings
            can be specified for the <literal>"name"</literal>,
            <literal>"version"</literal>, and <literal>"platform"</literal> keys
            of this array, and will be appended to the respective field(s) in
            the handshake document.
           </para>
           <note>
            <simpara>
             Handshake information is limited to 512 bytes. The extension will
             truncate handshake data to fit within this 512-byte string. Higher
             level libraries are encouraged to keep their own metadata concise.
            </simpara>
           </note>
          </entry>
         </row>
         <row>
          <entry>pem_file</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            Path to a <acronym>PEM</acronym> encoded certificate to use for client authentication.
           </para>
           <para>
            This option is a deprecated alias for the
            <literal>"tlsCertificateKeyFile"</literal> URI option.
           </para>
          </entry>
         </row>
         <row>
          <entry>pem_pwd</entry>
          <entry><type>string</type></entry>
          <entry>
           <para>
            Passphrase for the <acronym>PEM</acronym> encoded certificate (if applicable).
           </para>
           <para>
            This option is a deprecated alias for the
            <literal>"tlsCertificateKeyFilePassword"</literal> URI option.
           </para>
          </entry>
         </row>
         <row>
          <entry>serverApi</entry>
          <entry><classname>MongoDB\Driver\ServerApi</classname></entry>
          <entry>
           <para>
            This option is used to declare a server API version for the manager.
            If omitted, no API version is declared.
           </para>
          </entry>
         </row>
         <row>
          <entry>weak_cert_validation</entry>
          <entry><type>bool</type></entry>
          <entry>
           <para>
            Disables certificate validation if &true;. Defaults to &false;
           </para>
           <para>
            This option is a deprecated alias for the
            <literal>"tlsAllowInvalidCertificates"</literal> URI option.
           </para>
          </entry>
         </row>
        </tbody>
       </tgroup>
      </table>
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </refsect1>

 <refsect1 role="errors">
  &reftitle.errors;
  <simplelist>
   &mongodb.throws.argumentparsing;
   <member>Throws <classname>MongoDB\Driver\Exception\RuntimeException</classname> if the <parameter>uri</parameter> format is invalid</member>
  </simplelist>
 </refsect1>

 <refsect1 role="changelog">
  &reftitle.changelog;
  <para>
   <informaltable>
    <tgroup cols="2">
     <thead>
      <row>
       <entry>&Version;</entry>
       <entry>&Description;</entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>PECL mongodb 1.16.0</entry>
       <entry>
        <para>
         The AWS KMS provider for client-side encryption now accepts a
         <literal>"sessionToken"</literal> option, which can be used to
         authenticate with temporary AWS credentials.
        </para>
        <para>
         Added <literal>"tlsDisableOCSPEndpointCheck"</literal> to the
         <literal>"tlsOptions"</literal> field of the
         <literal>"autoEncryption"</literal> driver option.
        </para>
        <para>
         If an empty document is specified for the <literal>"azure"</literal> or
         <literal>"gcp"</literal> KMS provider, the driver will attempt to
         configure the provider using
         <link xlink:href="&url.mongodb.specs;/blob/master/source/client-side-encryption/client-side-encryption.rst#automatic-credentials">Automatic Credentials</link>.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.15.0</entry>
       <entry>
        <para>
         If an empty document is specified for the <literal>"aws"</literal> KMS
         provider, the driver will attempt to configure the provider using
         <link xlink:href="&url.mongodb.specs;/blob/master/source/client-side-encryption/client-side-encryption.rst#automatic-credentials">Automatic Credentials</link>.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.14.0</entry>
       <entry>
        <para>
         Added the <literal>"bypassQueryAnalysis"</literal> and
         <literal>"encryptedFieldsMap"</literal> auto encryption options.
         Additional options pertaining to <literal>crypt_shared</literal> are
         now supported in the <literal>"extraOptions"</literal> auto encryption
         option.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.13.0</entry>
       <entry>
        <para>
         Added the <literal>"srvMaxHosts"</literal> and
         <literal>"srvServiceName"</literal> URI options.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.12.0</entry>
       <entry>
        <para>
         KMIP is now supported as a KMS provider for client-side encryption and
         may be configured in the <literal>"kmsProviders"</literal> field of the
         <literal>"autoEncryption"</literal> driver option. Additionally, TLS
         options for KMS providers may now be configured in the
         <literal>"tlsOptions"</literal> field of the
         <literal>"autoEncryption"</literal> driver option.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.11.0</entry>
       <entry>
        <para>
         Added the <literal>"loadBalanced"</literal> URI option.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.10.0</entry>
       <entry>
        <para>
         Added the <literal>"disableClientPersistence"</literal> driver option.
        </para>
        <para>
         Azure and GCP are now supported as KMS providers for client-side
         encryption and may be configured in the
         <literal>"kmsProviders"</literal> field of the
         <literal>"autoEncryption"</literal> driver option. Base64-encoded
         strings are now accepted as an alternative to
         <classname>MongoDB\BSON\Binary</classname> for options within
         <literal>"kmsProviders"</literal>.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.8.0</entry>
       <entry>
        <para>
         Added the <literal>"directConnection"</literal>,
         <literal>"tlsDisableCertificateRevocationCheck"</literal>, and
         <literal>"tlsDisableOCSPEndpointCheck"</literal> URI options.
        </para>
        <para>
         Added the <literal>"driver"</literal> driver option.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.7.0</entry>
       <entry>
        <para>
         Added the <literal>"autoEncryption"</literal> driver option.
        </para>
        <para>
         Specifying any SSL or TLS option via the <parameter>driverOptions</parameter>
         parameter will now implicitly enable TLS, as is done for the
         corresponding URI options.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.6.0</entry>
       <entry>
        <para>
         Added the <literal>"retryReads"</literal>, <literal>"tls"</literal>,
         <literal>"tlsAllowInvalidCertificates"</literal>,
         <literal>"tlsAllowInvalidHostnames"</literal>,
         <literal>"tlsCAFile"</literal>,
         <literal>"tlsCertificateKeyFile"</literal>,
         <literal>"tlsCertificateKeyFilePassword"</literal>, and
         <literal>"tlsInsecure"</literal> URI options.
        </para>
        <para>
         The <literal>"retryWrites"</literal> URI option defaults to &true;.
        </para>
        <para>
         Specifying any SSL or TLS URI option via the connection string or
         <parameter>uriOptions</parameter> parameter will now implicitly enable
         TLS unless <literal>ssl</literal> or <literal>tls</literal> is &false;.
         TLS is <emphasis>not</emphasis> implicitly enabled for any options in
         the <parameter>driverOptions</parameter> parameter, which is unchanged
         from previous versions.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.5.0</entry>
       <entry>
        <para>
         <literal>"wtimeoutMS"</literal> is now always validated and applied to
         the write concern. Previously, the option was ignored if
         <literal>"w"</literal> was &lt;= 1, since the timeout only applies to
         replication.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.4.0</entry>
       <entry>
        <para>
         Added the <literal>"compressors"</literal>,
         <literal>"retryWrites"</literal>, and
         <literal>"zlibCompressionLevel"</literal> URI options.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.3.0</entry>
       <entry>
        <para>
         The <parameter>uriOptions</parameter> argument now accepts
         <literal>"authMechanism"</literal> and
         <literal>"authMechanismProperties"</literal> options. Previously, these
         options were only supported in the <parameter>uri</parameter> argument.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.2.0</entry>
       <entry>
        <para>
         The <parameter>uri</parameter> argument defaults to
         <literal>"mongodb://127.0.0.1/"</literal>. The default port remains
         <literal>27017</literal>.
        </para>
        <para>
         Added the <literal>"appname"</literal> URI option.
        </para>
        <para>
         Added the <literal>"allow_invalid_hostname"</literal>,
         <literal>"ca_file"</literal>, <literal>"ca_dir"</literal>,
         <literal>"clr_file"</literal>, <literal>"pem_file"</literal>,
         <literal>"pem_pwd"</literal>, and
         <literal>"weak_cert_validation"</literal> driver options.
        </para>
        <para>
         The PHP Streams API is no longer used for socket communication. The
         <literal>"connectTimeoutMS"</literal> URI option now defaults to 10
         seconds instead of
         <link linkend="ini.default-socket-timeout">default_socket_timeout</link>
         in previous versions. Additionally, the extension no longer supports
         all <link linkend="context.ssl">SSL context options</link> via the
         <literal>"context"</literal> driver option.
        </para>
       </entry>
      </row>
      <row>
       <entry>PECL mongodb 1.1.0</entry>
       <entry>
        <para>
         The <parameter>uri</parameter> argument is optional and defaults to
         <literal>"mongodb://localhost:27017/"</literal>.
        </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </informaltable>
  </para>
 </refsect1>

 <refsect1 role="examples">
  &reftitle.examples;
  <example>
   <title><function>MongoDB\Driver\Manager::__construct</function> basic examples</title>
   <para>Connecting to standalone MongoDB node:</para>
   <programlisting role="php">
<![CDATA[
<?php

$manager = new MongoDB\Driver\Manager("mongodb://example.com:27017");

?>
]]>
   </programlisting>
   <para>
    Connecting to standalone MongoDB node via a Unix domain socket. The socket
    path may include special characters such as slashes and should be encoded
    with <function>rawurlencode</function>.
   </para>
   <programlisting role="php">
<![CDATA[
<?php

$manager = new MongoDB\Driver\Manager("mongodb://" . rawurlencode("/tmp/mongodb-27017.sock"));

?>
]]>
   </programlisting>
   <para>Connecting to a replica set:</para>
   <programlisting role="php">
<![CDATA[
<?php

$manager = new MongoDB\Driver\Manager("mongodb://rs1.example.com,rs2.example.com/?replicaSet=myReplicaSet");

?>
]]>
   </programlisting>
   <para>Connecting to a sharded cluster (i.e. one or more mongos instances):</para>
   <programlisting role="php">
<![CDATA[
<?php

$manager = new MongoDB\Driver\Manager("mongodb://mongos1.example.com,mongos2.example.com/");

?>
]]>
   </programlisting>
   <para>Connecting to MongoDB with authentication credentials for a particular user and database:</para>
   <programlisting role="php">
<![CDATA[
<?php

$manager = new MongoDB\Driver\Manager("mongodb://myusername:mypassword@example.com/?authSource=databaseName");

?>
]]>
   </programlisting>

   <para>
    Connecting to MongoDB with authentication credentials for a particular
    user and database, where the username or password includes special
    characters (e.g. <literal>@</literal>, <literal>:</literal>,
    <literal>%</literal>). In the following example, the password string
    <literal>myp@ss:w%rd</literal> has been manually escaped; however,
    <function>rawurlencode</function> may also be used to escape URI components
    that may contain special characters.
   </para>
   <programlisting role="php">
<![CDATA[
<?php

$manager = new MongoDB\Driver\Manager("mongodb://myusername:myp%40ss%3Aw%25rd@example.com/?authSource=databaseName");

?>
]]>
   </programlisting>

   <para>Connecting to MongoDB with X509 authentication:</para>
   <programlisting role="php">
<![CDATA[
<?php

$manager = new MongoDB\Driver\Manager(
    "mongodb://example.com/?ssl=true&authMechanism=MONGODB-X509",
    [],
    [
        "pem_file" => "/path/to/client.pem",
    ]
);
?>
]]>
   </programlisting>
  </example>
 </refsect1>

 <refsect1 role="seealso">
  &reftitle.seealso;
  <simplelist>
   <member><link linkend="mongodb.connection-handling">Connection handling and persistence</link></member>
   <member><link xlink:href="&url.mongodb.docs;reference/connection-string/">MongoDB Connection String Format</link></member>
  </simplelist>
 </refsect1>

</refentry>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
indent-tabs-mode:nil
sgml-parent-document:nil
sgml-default-dtd-file:"~/.phpdoc/manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
vim600: syn=xml fen fdm=syntax fdl=2 si
vim: et tw=78 syn=sgml
vi: ts=1 sw=1
-->
